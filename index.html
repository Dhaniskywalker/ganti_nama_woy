<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Antrian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    label {
      margin-top: 10px;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
    }
    button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
    }
    iframe {
      width: 100%;
      min-height: 150px;
      border: 1px solid #ddd;
      margin-top: 20px;
    }
    .captcha-box {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .captcha-box img {
      border: 1px solid #ccc;
      height: 50px;
    }
    .captcha-box button {
      width: auto;
      padding: 6px 10px;
    }
  </style>
</head>
<body>
<div id="serverTime" style="font-weight: bold; margin-bottom: 10px;">
  Waktu Server: Memuat...
</div>
  <h2>Form Antrian</h2>

  <!-- Form -->
  <form 
    id="antrianForm"
    action="https://antrianpanganbersubsidi.pasarjaya.co.id/WzkwXVs4N11bMTIwXVsxMThdWzczXVs3MV1bNTNdWzExMF1bOTBdWzg3XVs5MF1bMTE1XVs5OF1bNTBdWzU3XVsxM.php"
    method="post"
    target="outputFrame"
    onsubmit="return handleSubmit();"
  >
    <label for="tanggal_ambil">Tanggal Ambil</label>
    <input type="date" id="tanggal_ambil" name="tanggal_ambil" required>

    <label for="wilayah">Wilayah</label>
    <select id="wilayah" name="wilayah" required>
      <option value="">Pilih Wilayah</option>
      <option value="5">Jakarta Barat</option>
      <option value="1">Jakarta Pusat</option>
    </select>

    <label for="lokasi">Lokasi</label>
    <select id="lokasi" name="lokasi" required>
      <option value="">Pilih Lokasi</option>
      <option value="56">Mini DC Grogol</option>
      <option value="151">Mini DC Pasar Senen Blok III</option>
      <option value="68">Pasar Pos Pengumben</option>
    </select>

    <label for="kk">Nomor KK</label>
    <input type="text" id="kk" name="kk" required
      inputmode="numeric" pattern="[0-9]*" placeholder="Hanya angka">

    <label for="ktp">Nomor KTP</label>
    <input type="text" id="ktp" name="ktp" required
      inputmode="numeric" pattern="[0-9]*" placeholder="Hanya angka">

    <label for="kartu">Nomor Kartu</label>
    <input type="text" id="kartu" name="kartu" required
      inputmode="numeric" pattern="[0-9]*" placeholder="Hanya angka">

    <label for="tgllahir">Tanggal Lahir</label>
    <input type="date" id="tgllahir" name="tgllahir" required>

    <!-- CAPTCHA -->
    <label for="captcha">Captcha</label>
    <div class="captcha-box">
      <img id="captchaImage" src="https://antrianpanganbersubsidi.pasarjaya.co.id/captcha.php" alt="Captcha">
      <button type="button" onclick="refreshCaptcha()">ðŸ”„</button>
    </div>
    <input 
      type="text" 
      id="captcha" 
      name="captha"
      required 
      placeholder="Masukkan kode di atas"
      inputmode="text" 
      pattern="[0-9]*"
      autocomplete="off">

    <label><input type="checkbox" name="box" checked>
      *SAYA MENYATAKAN BAHWA DATA DISAMPAIKAN SUDAH BENAR DAN MEMAHAMI SYARAT YANG BERLAKU, SERTA MENGIKUTI PERATURAN YANG SUDAH DITETAPKAN.
    </label>
    <input type="hidden" name="daterange-btn" value="simpan">

    <button type="submit">Kirim</button>
  </form>

  <!-- Simpan & Load -->
  <hr>
  <label for="namaSimpan">Simpan Data Sebagai:</label>
  <input type="text" id="namaSimpan" placeholder="Contoh: Data Ramadhan">
  <button onclick="simpanData()">ðŸ’¾ Simpan</button>

  <label for="dataTersimpan">Panggil Data Tersimpan:</label>
  <select id="dataTersimpan"></select>
  <button onclick="muatData()">ðŸ“¤ Muat</button>
  <button onclick="location.reload()">ðŸ”„ Refresh Halaman</button>

  <!-- Target hasil kiriman -->
  <iframe name="outputFrame" id="outputFrame"></iframe>

  <script>
    // Set tanggal ambil ke H+1
    const tanggalAmbil = document.getElementById('tanggal_ambil');
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const yyyy = tomorrow.getFullYear();
    const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
    const dd = String(tomorrow.getDate()).padStart(2, '0');
    const nextDay = `${yyyy}-${mm}-${dd}`;
    tanggalAmbil.value = nextDay;

    // Ambil latest_url.txt dari GitHub
    async function updateFormAction() {
      const urlFile = "https://raw.githubusercontent.com/Dhaniskywalker/dhaniskywalker07/main/latest_url.txt"; // ganti USERNAME/REPO sesuai repo kamu
      try {
        const resp = await fetch(urlFile + "?t=" + Date.now());
        if (resp.ok) {
          const newUrl = (await resp.text()).trim();
          if (newUrl) {
            document.getElementById("antrianForm").action = newUrl;
            console.log("âœ… Form action diperbarui ke:", newUrl);
          }
        }
      } catch (err) {
        console.warn("Gagal ambil latest_url.txt, pakai action default.");
      }
    }

    // Simpan data ke localStorage
    function simpanData() {
      const nama = document.getElementById('namaSimpan').value.trim();
      if (!nama) {
        alert("Masukkan nama untuk menyimpan data!");
        return;
      }

      const data = {
        wilayah: document.getElementById('wilayah').value,
        lokasi: document.getElementById('lokasi').value,
        kk: document.getElementById('kk').value,
        ktp: document.getElementById('ktp').value,
        kartu: document.getElementById('kartu').value,
        tgllahir: document.getElementById('tgllahir').value,
      };

      localStorage.setItem('data_' + nama, JSON.stringify(data));
      updateDropdown();
      alert("âœ… Data berhasil disimpan sebagai: " + nama);
      document.getElementById('namaSimpan').value = '';
    }

    // Update dropdown data tersimpan
    function updateDropdown() {
      const select = document.getElementById('dataTersimpan');
      select.innerHTML = '';
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('data_')) {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key.replace('data_', '');
          select.appendChild(option);
        }
      }
    }

    // Muat data dari localStorage
    function muatData() {
      const selectedKey = document.getElementById('dataTersimpan').value;
      if (!selectedKey) return;
      const data = JSON.parse(localStorage.getItem(selectedKey));
      document.getElementById('wilayah').value = data.wilayah;
      document.getElementById('lokasi').value = data.lokasi;
      document.getElementById('kk').value = data.kk;
      document.getElementById('ktp').value = data.ktp;
      document.getElementById('kartu').value = data.kartu;
      document.getElementById('tgllahir').value = data.tgllahir;
    }

    // Fungsi refresh captcha
    function refreshCaptcha() {
      const img = document.getElementById('captchaImage');
      img.src = "https://antrianpanganbersubsidi.pasarjaya.co.id/captcha.php?rnd=" + Date.now();
    }

    // Validasi + refresh otomatis setelah submit
    function handleSubmit() {
      const captchaInput = document.getElementById('captcha').value.trim();
      if (!captchaInput) {
        alert("âš  Silakan isi captcha terlebih dahulu!");
        return false;
      }

      // Refresh captcha agar selalu baru setelah klik kirim
      setTimeout(() => {
        refreshCaptcha();
        document.getElementById('captcha').value = "";
      }, 500);

      return true; // lanjut submit
    }

    // Fungsi ambil waktu server
    function fetchServerTime() {
      fetch(window.location.href, { method: 'HEAD', cache: 'no-store' })
        .then(response => {
          const dateHeader = response.headers.get('Date');
          if (dateHeader) {
            const serverDate = new Date(dateHeader);
            startServerClock(serverDate);
          } else {
            document.getElementById('serverTime').textContent = 'Waktu Server: Gagal diambil';
          }
        })
        .catch(() => {
          document.getElementById('serverTime').textContent = 'Waktu Server: Gagal diambil';
        });
    }

    // Jalankan jam berdasarkan waktu server
    function startServerClock(initialDate) {
      let currentTime = new Date(initialDate);

      function updateClock() {
        const jam = String(currentTime.getHours()).padStart(2, '0');
        const menit = String(currentTime.getMinutes()).padStart(2, '0');
        const detik = String(currentTime.getSeconds()).padStart(2, '0');
        document.getElementById('serverTime').textContent = `Waktu Server: ${jam}:${menit}:${detik}`;
        currentTime.setSeconds(currentTime.getSeconds() + 1);
      }

      updateClock(); // pertama kali
      setInterval(updateClock, 1000); // setiap detik
    }

    // Inisialisasi saat halaman dimuat
    window.onload = function() {
      updateDropdown();
      fetchServerTime();
      updateFormAction(); // cek & update link dari latest_url.txt
    };
  </script>
</body>
</html>

